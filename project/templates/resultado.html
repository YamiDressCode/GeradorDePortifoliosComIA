{% extends "base.html" %}

{% block title %}{{ filename }} - RenewTec{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Cabeçalho do Resultado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">{{ filename }}</h1>
                <div class="btn-group">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </a>
                    <button id="saveHtml" class="btn btn-primary">
                        <i class="bi bi-download"></i> Salvar HTML
                    </button>
                </div>
            </div>

            <!-- Área de Visualização do Conteúdo -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="preview-tab" data-bs-toggle="tab" href="#preview">
                                Visualização
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="code-tab" data-bs-toggle="tab" href="#code">
                                Código Fonte
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="tab-content">
                        <!-- Preview Tab -->
                        <div class="tab-pane fade show active" id="preview">
                            <div class="p-4 content-preview">
                                {{ text|safe }}
                            </div>
                        </div>
                        
                        <!-- Code Tab -->
                        <div class="tab-pane fade" id="code">
                            <pre class="m-0 p-3 bg-light"><code class="language-html">{{ text|e }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opções Adicionais -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Opções</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary" onclick="copyToClipboard()">
                            <i class="bi bi-clipboard"></i> Copiar Código
                        </button>
                        <a href="data:text/html;charset=utf-8,{{ text|urlencode }}" 
                           class="btn btn-outline-success" download="conteudo-gerado.html">
                            <i class="bi bi-file-earmark-arrow-down"></i> Baixar HTML
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="saveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Salvar Conteúdo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Escolha um nome para o arquivo:</p>
                <input type="text" id="filenameInput" class="form-control" value="conteudo-gerado-{{ timestamp }}.html">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveContent()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- Highlight.js para syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

<script>
// Inicializa highlight.js
document.addEventListener('DOMContentLoaded', (event) => {
    hljs.highlightAll();
    
    // Ativa tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

// Função para copiar o código
function copyToClipboard() {
    const code = `{{ text|e }}`;
    navigator.clipboard.writeText(code).then(() => {
        const tooltip = new bootstrap.Tooltip(document.getElementById('copyBtn'), {
            title: 'Copiado!',
            trigger: 'manual'
        });
        tooltip.show();
        setTimeout(() => tooltip.hide(), 2000);
    });
}

// Função para salvar o conteúdo
function saveContent() {
    const filename = document.getElementById('filenameInput').value;
    const content = `{{ text|e }}`;
    
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    // Fecha o modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('saveModal'));
    modal.hide();
}

// Evento do botão Salvar HTML
document.getElementById('saveHtml').addEventListener('click', () => {
    const modal = new bootstrap.Modal(document.getElementById('saveModal'));
    modal.show();
});
</script>

<style>
/* Estilos personalizados */
.content-preview {
    max-height: 70vh;
    overflow-y: auto;
    background-color: #f8f9fa;
    border-radius: 0 0 0.375rem 0.375rem;
}

.nav-tabs .nav-link.active {
    font-weight: 500;
}

pre code {
    border-radius: 0 0 0.375rem 0.375rem;
    max-height: 70vh;
    overflow-y: auto;
    display: block;
}

.tab-content {
    min-height: 300px;
}
</style>
{% endblock %}